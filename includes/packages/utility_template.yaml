utility_template:
  
  template:
    - binary_sensor:
        - name: "Саша дома"
          state: >
            {{ is_state('device_tracker.poco_x5_pro_5g', 'home') or
               is_state('device_tracker.poco_x5_pro_5g_2', 'home') or
               is_state('device_tracker.poco_x5_pro_5g_3', 'home') }}

        - name: "Лена дома"
          state: >
            {{ is_state('device_tracker.xiaomi_11_lite_5g_ne', 'home') or
               is_state('device_tracker.xiaomi_11_lite_5g_ne_2', 'home') or
               is_state('device_tracker.redmi_note_14_pro_5g', 'home') or
               is_state('device_tracker.xiaomi_11_lite_5g_ne_3', 'home') }}
               
        - name: "internet_off"
          unique_id: internet_off
          state: >
            {{ states('sensor.mikrotik_router_download_speed') | float(0) < 1 }}
          delay_on: 
            seconds: 30
    - sensor:
        - name: "sensor.Kotel_Power_Delta"
          state: >
            {{ (
              states('sensor.kotel_power_2')|float(0) - 
              states('sensor.kotel_zariad_power')|float(0)
            )|round(2) }}
          unit_of_measurement: "W"
          device_class: power
          state_class: measurement

        - name: "Заряд датчиков"
          unique_id: low_battery_sensor_main
          state: >
            {% set batteries = [
              'sensor.motion_sensor_2_battery_2',
              'sensor.temp1_battery',
              'sensor.temp2_battery',
              'sensor.temp3_battery',
              'sensor.temp4_battery',
              'sensor.temp5_battery',
              'sensor.temp6_battery',
              'sensor.wireless_scene_switch_battery',
              'sensor.spalnia_shtora_battery'
            ] %}
            {% for entity in batteries %}
              {% set val = states(entity) | int(100) %}
              {% if val < 50 %}
                {{ state_attr(entity, 'friendly_name') or entity }}
                {% break %}
              {% endif %}
            {% endfor %}
          icon: mdi:battery-alert
          attributes:
            battery_levels: >
              {% set out = namespace(result=[]) %}
              {% set batteries = [
                'sensor.motion_sensor_2_battery_2',
                'sensor.temp1_battery',
                'sensor.temp2_battery',
                'sensor.temp3_battery',
                'sensor.temp4_battery',
                'sensor.temp5_battery',
                'sensor.temp6_battery',
                'sensor.wireless_scene_switch_battery',
                'sensor.spalnia_shtora_battery'
              ] %}
              {% for entity in batteries %}
                {% set val = states(entity) | int(100) %}
                {% set name = state_attr(entity, 'friendly_name') or entity %}
                {% set out.result = out.result + [name ~ ': ' ~ val ~ '%'] %}
              {% endfor %}
              {{ out.result }}
