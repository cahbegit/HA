telegram_control:

  automation:

    ####################################################################
    # –°–¢–ê–†–¢ / –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
    ####################################################################
    - id: telegram_menu_start
      alias: Telegram ‚Äî —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é
      initial_state: true
      trigger:
        - platform: event
          event_type: telegram_command
          event_data:
            command: "/start"
      action:
        - service: telegram_bot.send_message
          data:
            target: "{{ trigger.event.data.user_id }}"
            message: |
              {{'\U0001F527'}} –í—ã–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
            inline_keyboard:
              - "üö∂ –ö–æ—Ä–∏–¥–æ—Ä:/koridor_control , üöΩ –¢—É–∞–ª–µ—Ç:/vanna_control"
              - "üè† –ó–∞–ª:/zal_control , üç¥ –ö—É—Ö–Ω—è:/kuhnya_control"
              - "üõèÔ∏è –°–ø–∞–ª—å–Ω—è:/spalnia_control , üåâ –ë–∞–ª–∫–æ–Ω:/balkon_control"
              - "üé• –°–≤–µ—Ç:/lights"
              - "üö´ –£–±—Ä–∞—Ç—å –º–µ–Ω—é:/menu_hide"

    ####################################################################
    # –ï–î–ò–ù–´–ô CALLBACK-–†–û–£–¢–ï–†
    ####################################################################
    - id: telegram_callback_router
      alias: Telegram ‚Äî callback router
      initial_state: true
      trigger:
        - platform: event
          event_type: telegram_callback

      action:
        - choose:

            ################################################################
            # –°–ö–†–´–¢–¨ –ú–ï–ù–Æ
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/menu_hide' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"

            ################################################################
            # –í–û–ó–í–†–ê–¢ –í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/menu_back' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      {{'\U0001F527'}} –í—ã–±—Ä–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
                    inline_keyboard:
                      - "üö∂ –ö–æ—Ä–∏–¥–æ—Ä:/koridor_control , üöΩ –¢—É–∞–ª–µ—Ç:/vanna_control"
                      - "üè† –ó–∞–ª:/zal_control , üç¥ –ö—É—Ö–Ω—è:/kuhnya_control"
                      - "üõèÔ∏è –°–ø–∞–ª—å–Ω—è:/spalnia_control , üåâ –ë–∞–ª–∫–æ–Ω:/balkon_control"
                      - "üé• –°–≤–µ—Ç:/lights"
                      - "üö´ –£–±—Ä–∞—Ç—å –º–µ–Ω—é:/menu_hide"

            ################################################################
            # –ö–û–†–ò–î–û–†
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/koridor_control' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      üö∂ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∏–¥–æ—Ä:
                      üö™ –î–≤–µ—Ä—å ‚Äî {% if is_state('binary_sensor.0x00158d000119378d_contact','on') %}–û—Ç–∫—Ä—ã—Ç–∞{% else %}–ó–∞–∫—Ä—ã—Ç–∞{% endif %}
                      üë£ –î–≤–∏–∂–µ–Ω–∏–µ ‚Äî {% if is_state('binary_sensor.0x00158d00010f8920_occupancy','on') %}–ï—Å—Ç—å{% else %}–ù–µ—Ç{% endif %}
                    inline_keyboard:
                      - "üí° –õ–∞–º–ø–æ—á–∫–∞:/toggle_koridor_light"
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            - conditions: "{{ trigger.event.data.command == '/toggle_koridor_light' }}"
              sequence:
                - service: switch.toggle
                  target:
                    entity_id: switch.1_ty_12z_switch_1
                - service: telegram_bot.answer_callback_query
                  data:
                    callback_query_id: "{{ trigger.event.data.id }}"
                    message: "üí° –ö–æ—Ä–∏–¥–æ—Ä –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω"
                - delay: "00:00:01"
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: "üí° –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ"
                    inline_keyboard:
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            ################################################################
            # –í–ê–ù–ù–ê
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/vanna_control' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      üöΩ –í–∞–Ω–Ω–∞:
                      üå°Ô∏è {{ states('sensor.temp6_temperature') }} ¬∞C
                      üíß {{ states('sensor.temp6_humidity') }} %
                    inline_keyboard:
                      - "üí° –õ—é—Å—Ç—Ä–∞:/toggle_vanna_light"
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            - conditions: "{{ trigger.event.data.command == '/toggle_vanna_light' }}"
              sequence:
                - service: switch.toggle
                  target:
                    entity_id: switch.2_ty_12z_switch_2
                - service: telegram_bot.answer_callback_query
                  data:
                    callback_query_id: "{{ trigger.event.data.id }}"
                    message: "üí° –í–∞–Ω–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞"

            ################################################################
            # –ó–ê–õ
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/zal_control' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      üè† –ó–∞–ª:
                      üå°Ô∏è {{ states('sensor.temp4_temperature') }} ¬∞C
                      üíß {{ states('sensor.temp4_humidity') }} %
                    inline_keyboard:
                      - "üí° –õ—é—Å—Ç—Ä–∞ 1:/toggle_zal1 , üí° –õ—é—Å—Ç—Ä–∞ 2:/toggle_zal2"
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            - conditions: "{{ trigger.event.data.command == '/toggle_zal1' }}"
              sequence:
                - service: switch.toggle
                  target:
                    entity_id: switch.1_ty_12z_switch_4
                - service: telegram_bot.answer_callback_query
                  data:
                    callback_query_id: "{{ trigger.event.data.id }}"
                    message: "üí° –ó–∞–ª (1 –ª–∞–º–ø—ã)"

            - conditions: "{{ trigger.event.data.command == '/toggle_zal2' }}"
              sequence:
                - service: switch.toggle
                  target:
                    entity_id: switch.1_ty_12z_switch_5
                - service: telegram_bot.answer_callback_query
                  data:
                    callback_query_id: "{{ trigger.event.data.id }}"
                    message: "üí° –ó–∞–ª (2 –ª–∞–º–ø—ã)"

            ################################################################
            # –ö–£–•–ù–Ø
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/kuhnya_control' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      üç¥ –ö—É—Ö–Ω—è:
                      üå°Ô∏è {{ states('sensor.temp3_temperature') }} ¬∞C
                      üíß {{ states('sensor.temp3_humidity') }} %
                    inline_keyboard:
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            ################################################################
            # –°–ü–ê–õ–¨–ù–Ø
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/spalnia_control' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      üõèÔ∏è –°–ø–∞–ª—å–Ω—è:
                      üå°Ô∏è {{ states('sensor.temp2_temperature') }} ¬∞C
                      üíß {{ states('sensor.temp2_humidity') }} %
                    inline_keyboard:
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            ################################################################
            # –ë–ê–õ–ö–û–ù
            ################################################################
            - conditions: "{{ trigger.event.data.command == '/balkon_control' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    chat_id: "{{ trigger.event.data.chat_id }}"
                    message_id: "{{ trigger.event.data.message.message_id }}"
                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: |
                      üåâ –ë–∞–ª–∫–æ–Ω:
                      üå°Ô∏è {{ states('sensor.temp1_temperature') }} ¬∞C
                      üíß {{ states('sensor.temp1_humidity') }} %
                    inline_keyboard:
                      - "‚Ü©Ô∏è –ù–∞–∑–∞–¥:/menu_back"

            ################################################################
            # –°–í–ï–¢ ‚Äî –°–ü–ò–°–û–ö –í–ö–õ–Æ–ß–Å–ù–ù–´–• –õ–ê–ú–ü–û–ß–ï–ö
            ################################################################
            - conditions:
                - condition: template
                  value_template: "{{ trigger.event.data.command == '/lights' }}"
              sequence:
                - service: telegram_bot.delete_message
                  data:
                    message_id: "{{ trigger.event.data.message.message_id }}"
                    chat_id: "{{ trigger.event.data.chat_id }}"

                - service: telegram_bot.send_message
                  data:
                    target: "{{ trigger.event.data.chat_id }}"
                    message: >
                      {% set lights = [
                        {'entity': 'switch.1_ty_12z_switch_1', 'name': '–ö–æ—Ä–∏–¥–æ—Ä'},
                        {'entity': 'switch.1_ty_12z_switch_6', 'name': '–°–ø–∞–ª—å–Ω—è —Ü–µ–Ω—Ç—Ä'},
                        {'entity': 'switch.1_ty_12z_switch_4', 'name': '–ó–∞–ª —Ü–µ–Ω—Ç—Ä'},
                        {'entity': 'switch.2_ty_12z_switch_1', 'name': '–°–∫–ª–∞–¥–æ–≤–∫–∞'},
                        {'entity': 'switch.1_ty_12z_switch_5', 'name': '–ó–∞–ª 2'},
                        {'entity': 'switch.2_ty_12z_switch_8', 'name': '–ó–∞–ª –±–∞–ª–∫–æ–Ω'},
                        {'entity': 'switch.1_ty_12z_switch_2', 'name': '–í—ã—Ç—è–∂–∫–∞ –≥–∞—Ä–¥–µ—Ä–æ–±'},
                        {'entity': 'switch.1_ty_12z_switch_3', 'name': '–í—ã—Ç—è–∂–∫–∞ –≤–∞–Ω–Ω–∞'},
                        {'entity': 'switch.2_ty_12z_switch_7', 'name': '–ö—É—Ö–Ω—è –±–∞–ª–∫–æ–Ω'},
                        {'entity': 'switch.2_ty_12z_switch_5', 'name': '–ö—É—Ö–Ω—è'},
                        {'entity': 'switch.2_ty_12z_switch_2', 'name': '–í–∞–Ω–Ω–∞ 1'},
                        {'entity': 'switch.2_ty_12z_switch_3', 'name': '–í–∞–Ω–Ω–∞ 2'},
                        {'entity': 'switch.2_ty_12z_switch_6', 'name': '–§–∞—Ä—Ç—É–∫'},
                        {'entity': 'switch.2_ty_12z_switch_4', 'name': '–î—É—à'},
                        {'entity': 'switch.1_ty_12z_switch_7', 'name': '–°–ø–∞–ª—å–Ω—è –±—Ä–∞ –ª–µ–≤–æ'},
                        {'entity': 'switch.1_ty_12z_switch_8', 'name': '–°–ø–∞–ª—å–Ω—è –±—Ä–∞ –ø—Ä–∞–≤–æ'}
                      ] %}

                      {% set on_lights = lights | selectattr('entity','is_state','on') | list %}

                      {% if on_lights | length > 0 %}
                      üí° *–í–∫–ª—é—á—ë–Ω–Ω—ã–µ –ª–∞–º–ø–æ—á–∫–∏:*
                      {% for light in on_lights %}
                      ‚Ä¢ {{ light.name }}
                      {% endfor %}
                      {% else %}
                      üö´ *–ù–µ—Ç –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö –ª–∞–º–ø–æ—á–µ–∫.*
                      {% endif %}
                    inline_keyboard:
                      - "‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è:/menu_back , üîÑ –û–±–Ω–æ–≤–∏—Ç—å:/lights"
